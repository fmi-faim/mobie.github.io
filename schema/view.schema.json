{
    "$schema": "http://json-schema.org/draft-07/schema",
    "$id": "https://raw.githubusercontent.com/mobie/mobie.github.io/master/schema/view.schema.json",
    "title": "MoBIEViewSchema",
    "description": "Schema for serializing the MoBIE viewer state",
    "definitions": {

        "name": {
            "type": "string",
            "pattern": "^[^;\\/ ]+$"
        },

        "imageDisplay": {
            "description": "",
            "type": "object",
            "properties": {
                "imageDisplay": {
                    "description": "Viewer state for a group of image sources.",
                    "type": "object",
                    "properties": {
                        "color": {
                            "description": "The color map.",
                            "type": "string",
                            "oneOf": [
                                {"pattern": "^r=(\\d+),g=(\\d+),b=(\\d+),a=(\\d+)$"},
                                {"enum": ["black", "blue", "cyan", "darkGray", "glasbeyFromRandom", "gray", "green", "lightGray", "magenta", "orange", "pink", "red", "white", "yellow"]}
                            ]
                        },
                        "contrastLimits": {
                            "description": "The contrast limits.",
                            "type": "array",
                            "items": [
                                {
                                    "type": "number",
                                    "minimum": 0,
                                    "maximum": 65535
                                },
                                {
                                    "type": "number",
                                    "minimum": 0,
                                    "maximum": 65535
                                }
                            ],
                            "additionalItems": false
                        },
                        "name": {
                            "description": "Name of this image display.",
                            "$ref": "#/definitions/name"
                        },
                        "resolution3dView": {
                            "description": "The resolution used for the 3d viewer, in physical units. Only relevant if 'showImageIn3d' is true. Will be determined automatically if not specified.",
                            "type": "array",
                            "items": {
                                "type": "number",
                                "exclusiveMinimum": 0
                            },
                            "minItems": 3,
                            "maxItems": 3
                        },
                        "showImagesIn3d": {
                            "description": "Whether to show the images in the 3d viewer.",
                            "type": "boolean"
                        },
                        "sources": {
                            "description": "The image sources that are part of this display group.",
                            "type": "array",
                            "items": {
                                "type": "string",
                                "pattern": "^[^,\\/ ]+$"
                            },
                            "minItems": 1
                        }
                    },
                    "required": ["color", "contrastLimits", "name", "sources"],
                    "additionalProperties": false
                }
            },
            "required": ["imageDisplay"],
            "additionalProperties": false
        },

        "segmentationDisplay": {
            "description": "Viewer state for a group of segmentation sources.",
            "type": "object",
            "properties": {
                "segmentationDisplay": {
                    "description": "",
                    "type": "object",
                    "properties": {
                        "alpha": {
                            "description": "The alpha value used for blending segmentation and image data in the viewer.",
                            "type": "number",
                            "minimum": 0,
                            "maximum": 1
                        },
                        "lut": {
                            "description": "The segmentation look-up-table for the segmentation coloring.",
                            "type": "string",
                            "enum": ["argbColumn", "blueWhiteRed", "glasbey", "viridis"]
                        },
                        "colorByColumn": {
                            "description": "Name of table column that is used for coloring. By default the 'label_id' column is used.",
                            "$ref": "#/definitions/name"
                        },
                        "resolution3dView": {
                            "description": "Resolution used for the 3d viewer, in physical units. Only relevant if 'showSelectedSegmentsIn3d' is true. Will be determined automatically if not specified.",
                            "type": "array",
                            "items": {
                                "type": "number",
                                "exclusiveMinimum": 0
                            },
                            "minItems": 3,
                            "maxItems": 3
                        },
                        "name": {
                            "description": "Name of this segmentation display.",
                            "$ref": "#/definitions/name"
                        },
                        "scatterPlotAxes": {
                            "description": "The names of columns which should be used for the scatter plot.",
                            "type": "array",
                            "items": {
                                "type": "string",
                                "pattern": "^[^; \\/]+;[^; \\/]+$" 
                            },
                            "maxItems": 2,
                            "minItems": 2
                        },
                        "selectedSegmentIds": {
                            "description": "List of selected segment ids.",
                            "type": "array",
                            "items": {
                                "type": "string",
                                "pattern": "^[^; \\/]+;\\d+;\\d+$"
                            }
                        },
                        "showScatterPlot": {
                            "description": "Whether to show the scatter plot.",
                            "type": "boolean"
                        },
                        "showSelectedSegmentsIn3d": {
                            "description": "Whether to show the selected segments in the 3d viewer.",
                            "type": "boolean"
                        },
                        "sources": {
                            "description": "The segmentation sources that are part of this display group.",
                            "type": "array",
                            "items": {
                                "$ref": "#/definitions/name"
                            },
                            "minItems": 1
                        },
                        "tables": {
                            "description": "Additional tables to load. If present, the default table will always be loaded and should not be specified here.",
                            "type": "array",
                            "items": {
                                "$ref": "#/definitions/name"
                            },
                            "minItems": 1
                        },
                        "valueLimits": {
                            "description": "Value limits for numerical color maps like 'blueWhiteRed'.",
                            "type": "array",
                            "items": [
                                {
                                    "type": "number"
                                },
                                {
                                    "type": "number"
                                }
                            ],
                            "additionalItems": false
                        }
                    },
                    "required": ["alpha", "lut", "name", "sources"],
                    "additionalProperties": false
                }
            },
            "required": ["segmentationDisplay"],
            "additionalProperties": false
        },

        "affine": {
            "description": "",
            "type": "object",
            "properties": {
                "affine": {
                    "description": "Affine transformation applied to a list of sources.",
                    "type": "object",
                    "properties": {
                        "parameters": {
                            "description": "Parameters of the affine transformation, using the BigDataViewer convention.",
                            "type": "array",
                            "items": {
                                "type": "number"
                            },
                            "minItems": 12,
                            "maxItems": 12
                        },
                        "sources": {
                            "description": "The sources this transformation is applied to.",
                            "type": "array",
                            "items": {
                                "$ref": "#/definitions/name"
                            },
                            "minItems": 1
                        },
                        "timepoints": {
                            "description": "The valid timepoints for this transformation. If none is given, the transformation is valid for all timepoints.",
                            "type": "array",
                            "items": {
                                "type": "integer",
                                "minimum": 0
                            },
                            "minItems": 1
                        }
                    },
                    "required": ["parameters", "sources"],
                    "additionalProperties": false
                }
            },
            "required": ["affine"],
            "additionalProperties": false
        },

        "autoGrid": {
            "description": "",
            "type": "object",
            "properties": {
                "autoGrid": {
                    "description": "Arange a list of soures in grid.",
                    "type": "object",
                    "properties": {
                        "sources": {
                            "description": "The sources for the grid. The outer list specifies the grid posititions, the inner list the sources per grid position.",
                            "type": "array",
                            "items": {
                                "type": "array",
                                "items": {
                                    "type": "string",
                                    "pattern": "^[^,\\/ ]+$"
                                },
                                "minItems": 1
                            },
                            "minItems": 2
                        },
                        "tableDataLocation": {
                            "description": "Location of the table directory for this grid view, relative to the dataset root directory.",
                            "type": "string",
                            "pattern": "^\\S+$"
                        },
                        "timepoints": {
                            "description": "The valid timepoints for this transformation. If none is given, the transformation is valid for all timepoints.",
                            "type": "array",
                            "items": {
                                "type": "integer"
                            },
                            "minItems": 1
                        }
                    },
                    "required": ["sources", "tableDataLocation"],
                    "additionalProperties": false
                }
            },
            "required": ["autoGrid"],
            "additionalProperties": false
        }
    },

    "type": "object",
    "properties": {
        "uiSelectionGroup": {
            "description": "Name of the UI from which this view can be selected.",
            "$ref": "#/definitions/name"
        },
        "sourceDisplays": {
            "description": "The display groups of this view.",
            "type": "array",
            "items": {"anyOf": [
                {"$ref": "#/definitions/imageDisplay"},
                {"$ref": "#/definitions/segmentationDisplay"}
            ]}
        },
        "sourceTransforms": {
            "description": "The source transformations of this view.",
            "type": "array",
            "items": {"anyOf": [
                {"$ref": "#/definitions/affine"},
                {"$ref": "#/definitions/autoGrid"}
            ]}
        },
        "viewerTransform": {
            "description": "The viewer transformation of this view.",
            "type": "object",
            "oneOf": [
                {
                    "properties": {
                        "timepoint": {
                            "description": "The initial timepoint shown in the viewer.",
                            "type": "integer",
                            "minimum": 0
                        }
                    },
                    "required": ["timepoint"],
                    "additionalProperties": false
                },
                {
                    "properties": {
                        "affine": {
                            "description": "Affine transformation applied by the viewer.",
                            "type": "array",
                            "items": {
                                "type": "number"
                            },
                            "minItems": 12,
                            "maxItems": 12
                        },
                        "timepoint": {
                            "description": "The initial timepoint shown in the viewer.",
                            "type": "integer",
                            "minimum": 0
                        }
                },
                "required": ["affine"],
                "additionalProperties": false
                },
                {
                    "properties": {
                        "normalizedAffine": {
                            "description": "Normalized affine transformation applied by the viewer.",
                            "type": "array",
                            "items": {
                                "type": "number"
                            },
                            "minItems": 12,
                            "maxItems": 12
                        },
                        "timepoint": {
                            "description": "The initial timepoint shown in the viewer.",
                            "type": "integer",
                            "minimum": 0
                        }
                    },
                    "required": ["normalizedAffine"],
                    "additionalProperties": false
                },
                {
                    "properties": {
                        "position": {
                            "description": "Position that will be centered in the viewer.",
                            "type": "array",
                            "items": {
                                "type": "number",
                                "minimum": 0
                            },
                            "minItems": 3,
                            "maxItems": 3
                        },
                        "timepoint": {
                            "description": "The initial timepoint shown in the viewer.",
                            "type": "integer",
                            "minimum": 0
                        }
                    },
                    "required": ["position"],
                    "additionalProperties": false
                }
            ]
        }
    },
    "required": ["uiSelectionGroup"],
    "additionalProperties": false
}
